{% extends "base.html" %}

{% block content %}
    <h2>{{ _('Buy Key Creation Credits') }}</h2>
    <p class="lead">{{ _('Each credit allows you to create one set of Hive keys.') }}</p>
    <p><strong>{{ _('Price:') }}</strong> ${{ "%.2f"|format(price) }} USD {{ _('per credit') }}</p>

    {% if hive_claim_tickets == 0 %}
        <div class="alert alert-warning" role="alert">
            {{ _('Currently, no key creation tickets are available. Please check back later!') }}
        </div>
    {% elif hive_claim_tickets < 5 %} <div class="alert alert-info" role="alert">
        {{ _('Only single key creation tickets are available at the moment. More will be available soon!') }}
    </div>
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">{{ _('Single Credit') }}</h5>
                        <p class="card-text">{{ _('Perfect for creating your first keys.') }}</p>
                        <div id="paypal-button-container-1"></div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">{{ _('Single Credit') }}</h5>
                        <p class="card-text">{{ _('Perfect for creating your first account.') }}</p>
                        <div id="paypal-button-container-1"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">{{ _('Pack of 5') }}</h5>
                        <p class="card-text">{{ _('Onboard your friends and family!') }}</p>
                        <div id="paypal-button-container-5"></div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <script src="https://www.paypal.com/sdk/js?client-id={{ client_id }}&currency=USD"></script>
    <script>
        function setupPaypal(containerId, qty) {
            paypal.Buttons({
                createOrder: function (data, actions) {
                    return fetch('{{ url_for("paypal.create_order") }}', {
                        method: 'post',
                        headers: {
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify({
                            quantity: qty
                        })
                    }).then(function (res) {
                        return res.json();
                    }).then(function (orderData) {
                        return orderData.id;
                    });
                },
                onApprove: function (data, actions) {
                    return fetch('{{ url_for("paypal.capture_order", order_id="") }}' + data.orderID, {
                        method: 'post',
                        headers: {
                            'content-type': 'application/json'
                        }
                    }).then(function (res) {
                        return res.json();
                    }).then(function (orderData) {
                        if (orderData.status === 'COMPLETED') {
                            alert('Transaction completed! You have received ' + qty + ' credit(s).');
                            window.location.href = '{{ url_for("account.create") }}';
                        }
                    });
                }
            }).render('#' + containerId);
        }

        // Only setup PayPal buttons if their containers exist
        {% if hive_claim_tickets >= 1 %}
            if (document.getElementById('paypal-button-container-1')) {
                setupPaypal('paypal-button-container-1', 1);
            }
        {% endif %}
        {% if hive_claim_tickets >= 5 %}
            if (document.getElementById('paypal-button-container-5')) {
                setupPaypal('paypal-button-container-5', 5);
            }
        {% endif %}
    </script>
{% endblock %}